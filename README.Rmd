---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  message = FALSE
)
```
# mermaidr

<!-- badges: start -->
<!-- badges: end -->

The goal of `mermaidr` is to access [MERMAID Collect](https://collect.datamermaid.org/) data directly from R.

## Installation

You can install mermaidr from GitHub with:

``` r
# install.packages("remotes")
remotes::install_github("data-mermaid/mermaidr@package", upgrade = "never")
```

Next, load the package:

```{r}
library(mermaidr)
```

## Authentication

`mermaidr` will help you interact with MERMAID Collect as an authenticated user, as soon as you need. This is only required for accessing project specific data. To access a list of projects, sites, etc, you do not need to be authenticated.

If you would like to authenticate yourself immediately, use `mermaid_auth()`. This will open your browser to the MERMAID Collect login. Once you log in, you can go back to R and will be authenticated.

The login credentials expire every 24 hours. Once your credentials are expired, `mermaidr` will again help you automatically authenticate when needed.

## Usage

All functions in `mermaidr` are of the form `mermaid_*()`, to make functions easier to find and use when loaded with other packages!

To access the unauthenticated API endpoints (e.g. endpoints that are not related to a specific project), use `mermaid_get_endpoint()`. The results will return as a `tibble.` The following endpoints are available: "benthicattributes", "choices" (a way to lookup values from IDs),  "fishfamilies", "fishgenera", "fishspecies", "fishsizes", "managements", "projects", "projecttags", "sites".

For example,

```{r}
library(mermaidr)

mermaid_get_endpoint("sites")
```

By default, the function returns all results - to get less, use the `limit` argument:

```{r}
mermaid_get_endpoint("managements", limit = 5)
```

For specifically listing projects, there is a wrapper function `mermaid_list_projects()`:

```{r}
mermaid_list_projects(limit = 5)
```

This will list all (as many as `limit`) projects. By default, it does *not* include test projects. To include test projects, set `include_test_projects = TRUE`.

To specifically access projects that you *have access to*, use `mermaid_list_my_projects()`:

```{r}
mermaid_list_my_projects(limit = 1)
```

This will return a list of projects that you have access to in Collect. Again, this does not include test projects.

#### Multiple endpoints

To get data from multiple endpoints, pass a vector of endpoints. You will get a list of tibbles:

```{r}
mermaid_get_endpoint(c("managements", "sites"), limit = 1)
```

### Accessing project data

#### Getting projects

You will be able to access data from a specific project, provided that you have access to it in the Collect app. To access data for a project, you can either use a project from `mermaid_list_my_projects()` (as above), a `project_id` directly, or a project from `mermaid_search_projects()`. 

For example:

```{r}
mermaidr_project <- mermaid_search_projects(name = "Sharla test", include_test_projects = TRUE)

mermaidr_project
```

returns a single project with the name "Sharla test".

You can also search projects by country or tag:

```{r}
mermaid_search_projects(country = "Fiji")
```

and if you only want to search *your* projects, pass your token to the function:

```{r}
mermaid_search_projects(country = "Fiji", token = mermaid_token())
```

Note that the country and tag searches search if the countries/tag fields *contain* that value, since they may not always be exactly what you expect. For example, to search projects in Tanzania:

```{r}
mermaid_search_projects(country = "Tanzania", limit = 1)[["countries"]]
```

If you need help figuring out what a country is named, use `mermaid_countries()`, which will list how countries are named in MERMAID:

```{r}
head(mermaid_countries())
```

#### Getting the data

You can use this project result to access an endpoint for the project, using `mermaid_get_project_endpoint()`. Details on the endpoints available are below.

At this point, you will have to authenticate to the Collect app. R will help you do this automatically by opening a browser window for you to log in to Collect, either via Google sign-in or username and password - however you normally do!

Once you've logged in, come back to R. Your login credentials will be stored for a day, until they expire, and you will need to login again. The package handles the expiration for you, so just log in again when prompted.

#### Aggregated endpoints

The "clean", aggregated endpoints currently available are for beltfish records: "beltfishes/obstransectbeltfishes", "beltfishes/sampleunits", and "beltfishes/sampleevents" and Benthic PIT records: ...

##### Observations

The "obs" endpoints show individual observations:

```{r}
xpdc <- mermaid_search_projects("XPDC Kei Kecil 2018")

mermaid_get_project_endpoint(xpdc, "beltfishes/obstransectbeltfishes", limit = 5)
mermaid_get_project_endpoint(xpdc, "benthicpits/obstransectbenthicpits", limit = 5)
```

##### Sample Units

The "sampleunits" endpoints are aggregated to the sample unit level. 

Fishbelt sample units contain total biomass in kg/ha per sample unit, by trophic group:

```{r}
mermaid_get_project_endpoint(xpdc, "beltfishes/sampleunits", limit = 5)
```

Benthic PIT sample units contain percent cover per sample unit, by benthic category:

```{r}
mermaid_get_project_endpoint(xpdc, "benthicpits/sampleunits", limit = 5)
```

##### Sample Events

The "sampleevents" endpoints are aggregated further, to the sample event level. 

Fishbelt sample events contain *mean* total biomass in kg/ha per sample event and by trophic group:

```{r}
mermaid_get_project_endpoint(xpdc, "beltfishes/sampleevents", limit = 5)
```

Benthic PIT sample events contain *mean* percent cover per sample event by benthic category:

```{r}
mermaid_get_project_endpoint(xpdc, "benthicpits/sampleevents", limit = 5)
```

#### Raw project endpoints

The following endpoints contain raw project data: "beltfishtransectmethods", "beltfishes", "benthiclittransectmethods", "benthicpittransectmethods", "benthicpits", "benthictransects", "collectrecords", "fishbelttransects", "habitatcomplexities", "obsbenthiclits", "obsbenthicpits", "obshabitatcomplexities", "obstransectbeltfishs", "managements", "observers", "project_profiles", "sampleevents", "sites".

For example, to see the sites in this project:

```{r}
mermaid_get_project_endpoint(mermaidr_project, "sites")
```

### How to specify projects

If you want to access data from the same project multiple times within a session, it may be useful to set the default project, rather than having to supply it every time. You can do this using `mermaid_set_default_project()`. Then, you can just supply the endpoint, and the default project is used.

```{r}
mermaid_set_default_project(xpdc)
mermaid_get_project_endpoint(endpoint = "sites", limit = 1)
```

You can also use the `project_id` directly to access data from a project, without having to search for it first. This may be handy since the `project_id` is directly available from the URL when using the Collect app.

```{r}
mermaid_get_project_endpoint("9de82789-c38e-462e-a1a8-e02c020c7a35", endpoint = "managements", limit = 1)
```

And you can access data from multiple project simultaneously:

```{r}
my_projects <- mermaid_list_my_projects()

my_projects

mermaid_get_project_endpoint(my_projects, "sites", limit = 1)
```
