---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  message = FALSE
)
```
# mermaidr

<!-- badges: start -->
<!-- badges: end -->

The goal of `mermaidr` is to access [MERMAID Collect](https://collect.datamermaid.org/) data directly from R.

## Installation

You can install mermaidr from GitHub with:

``` r
# install.packages("devtools")
devtools::install_github("data-mermaid/mermaidr@package", upgrade = "never")
```

Next, load the package:

```{r}
library(mermaidr)
```

## Authentication

`mermaidr` will help you interact with MERMAID Collect as an authenticated user, as soon as you need. This is only required for accessing project specific data. To access a list of projects, sites, etc, you do not need to be authenticated.

If you would like to authenticate yourself immediately, use `mermaid_auth()`. This will open your browser to the MERMAID Collect login. Once you log in, you can go back to R and will be authenticated.

The login credentials expire every 24 hours. Once your credentials are expired, `mermaidr` will again help you automatically authenticate when needed.

## Usage

All functions in `mermaidr` are of the form `mermaid_*()`, to make functions easier to find and use when loaded with other packages!

To access the unauthenticated API endpoints, use `mermaid_get_endpoint()`. The results will return as a `tibble.` The following endpoints are available: "benthicattributes", "fishattributes", "fishfamilies", "fishgenera", "fishspecies", "managements", "projects", "sites".

For example,

```{r}
library(mermaidr)

mermaid_get_endpoint("sites")
```

By default, the function returns all results - to get less, use the `limit` argument:

```{r}
mermaid_get_endpoint("managements", limit = 5)
```

For specifically listing projects, there is a wrapper function `mermaid_list_projects()`:

```{r}
mermaid_list_projects(limit = 5)
```

This will list all (as many as `limit`) projects. By default, it does *not* include test projects. To include test projects, set `include_test_projects = TRUE`.

To specifically access projects that you *have access to*, use `mermaid_list_my_projects()`:

```{r}
mermaid_list_my_projects(limit = 1)
```

This will return a list of projects that you have access to in Collect. Again, this does not include test projects.

### Accessing project data

You will be able to access data from a specific project, provided that you have access to it in the Collect app. To access data for a project, you can either use a project from `mermaid_list_my_projects()` (as above), a `project_id` directly, or a project from `mermaid_search_projects()`. 

For example:

```{r}
mermaidr_project <- mermaid_search_projects(name = "Sharla test")

mermaidr_project
```

returns a single project with the name "Sharla test".

You can also search projects by country or tag:

```{r}
mermaid_search_projects(country = "Fiji")
```

and if you only want to search *your* projects, pass your token to the function:

```{r}
mermaid_search_projects(country = "Fiji", token = mermaid_token())
```

You can use this to access an endpoint for the project, using `get_mermaid_project_endpoint()`. The following project endpoints are available: "beltfishtransectmethods", "beltfishes", "benthiclittransectmethods", "benthicpittransectmethods", "benthicpits", "collectrecords", "habitatcomplexities", "obsbenthiclits", "obsbenthicpits", "obshabitatcomplexities", "obstransectbeltfishs", "managements", "observers", "project_profiles", "sampleevents", "sites".

At this point, you will have to authenticate to the Collect app. R will help you do this automatically by opening a browser window for you to log in to Collect, either via Google sign-in or username and password - however you normally do!

Once you've logged in, come back to R. Your login credentials will be stored for a day, until they expire, and you will need to login again. The package handles the expiration for you, so just log in again when prompted.

#### Raw endpoints

The following endpoints contain raw data: "beltfishtransectmethods", "beltfishes", "benthiclittransectmethods", "benthicpittransectmethods", "benthicpits", "collectrecords", "habitatcomplexities", "obsbenthiclits", "obsbenthicpits", "obshabitatcomplexities", "obstransectbeltfishs", "managements", "observers", "project_profiles", "sampleevents", "sites", "beltfishes/obstransectbeltfishes/", "beltfishes/sampleunits/", and "beltfishes/sampleevents/".

Cleaner endpoints are covered in the next section. These are: "beltfishes/obstransectbeltfishes/", "beltfishes/sampleunits/", and "beltfishes/sampleevents/".

For example, to see the sites in this project:

```{r}
mermaid_get_project_endpoint(mermaidr_project, "sites")
```

You can also use the `project_id` directly to access data from a project, without having to search for it first. This may be handy since the `project_id` is directly available from the URL when using the collect app.

```{r}
mermaid_get_project_endpoint("2c0c9857-b11c-4b82-b7ef-e9b383d1233c", "managements")
```

If you want to access data from the same project multiple times within a session, it may be useful to set the default project, rather than having to supply it every time. You can do this using `mermaid_set_default_project()`. Then, you can just supply the endpoint, and the default project is used.

```{r}
mermaid_set_default_project(mermaidr_project)
mermaid_get_project_endpoint(endpoint = "beltfishes")
```

To get data for *all* endpoints associated with a project, use `mermaid_get_all_project_endpoints()`. This will return a list of tibbles, one for each endpoint.

```{r}
all_endpoints <- mermaid_get_all_project_endpoints()

names(all_endpoints)

all_endpoints[["sites"]]
```

Keep in mind that the default `limit` is 50, and should be increased if you want more records from each endpoint.

#### Clean Endpoints

The "clean" endpoints currently available are for beltfish records: "beltfishes/obstransectbeltfishes/", "beltfishes/sampleunits/", and "beltfishes/sampleevents/".

You can query them the same way, using 
`mermaid_get_project_endpoint()`:

"beltfishes/obstransectbeltfishes" are individual observations:

```{r}
xpdc <- mermaid_search_projects("XPDC Kei Kecil 2018")

mermaid_get_project_endpoint(xpdc, "beltfishes/obstransectbeltfishes", limit = 5)
```

"beltfishes/sampleunits/" are aggregated to the sample unit, and contain total biomass in kg/ha per sample unit, by trophic group:

```{r}
mermaid_get_project_endpoint(xpdc, "beltfishes/sampleunits", limit = 5)
```

"beltfishes/sampleevents/" are aggregated to the sample event, and contain *mean* total biomass in kg/ha per sample event and by trophic group:

```{r}
mermaid_get_project_endpoint(xpdc, "beltfishes/sampleevents", limit = 5)
```
