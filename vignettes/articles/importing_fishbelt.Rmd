---
title: Ingesting legacy data into MERMAID
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Get MERMAID project

Note `search-run` chunk is what will actually run, but not be shown (`echo = FALSE`), because it has the `include_test_projects = TRUE` flag, but we don't want users to worry about that.

```{r search-run, include = FALSE}
library(mermaidr)
library(tidyverse)

reef_survey <- mermaid_search_my_projects("MERMAID reef survey", include_test_projects = TRUE)
```

This chunk will show, but not run (`eval = FALSE`), mimicking as if we are just searching projects, not worrying about the test flag.

```{r search-show, eval = FALSE}
library(mermaidr)
library(tidyverse)

reef_survey <- mermaid_search_my_projects("MERMAID reef survey")
```

Get import template and options, save to a file called "fishbelt_mermaid_template.xlsx"

```{r template}
fish_template_and_options <- mermaid_import_get_template_and_options(
  reef_survey,
  "fishbelt",
  "fishbelt_mermaid_template.xlsx"
)
```

```{r email-options-edit, echo = FALSE}
# Altering the emails options behind the scenes so no actual emails are exposed
fish_template_and_options[["Observer emails *"]][["choices"]] <- tibble(value = "email@mermaid.org")
```

Maybe we can have a screenshot here of what the template looks like? But can also preview in R:

```{r}
names(fish_template_and_options)
```
 
Look at the template:

```{r}
fish_template_and_options[["Template"]]
```

Look at some options:

```{r}
fish_template_and_options[["Site *"]]
```

Read in data. Again, one chunk is actually run (the first) and one is shown (the second). The first is run because it is more specific to where the data is stored, but we assume people will be reading data from their Rstudio project directory - also using read_csv() in the second because it is commonly used, and we don't need to get into ; vs , here.

You will probably want to change the file location to reflect your own too.

```{r data-run, echo = FALSE, message = FALSE}
fishbelt_data <- read_delim(here::here("inst", "extdata", "import-fishbelt-vignette", "fishbelt.csv"), delim = ";")
sites_data <- read_delim(here::here("inst", "extdata", "import-fishbelt-vignette", "sites.csv"), delim = ";")
```

```{r data-show, eval = FALSE}
fishbelt_data <- read_csv("fishbelt.csv")
sites_data <- read_csv("sites.csv")
```

A number of columns are in the `sites` data set and need to be added to fishbelt:

```{r}
sites_data

fishbelt_data
```

```{r}
fishbelt_data <- fishbelt_data %>%
  left_join(sites_data, by = "SiteID")
```

Add columns manually - look at options to know what is allowed:

```{r}
fish_template_and_options[["Width *"]]
fish_template_and_options[["Fish size bin *"]]
fish_template_and_options[["Observer emails *"]]
```

```{r}
fishbelt_data <- fishbelt_data %>%
  mutate(
    `Width *` = "Mixed: >10 cm & <35 cm @ 5 m, >=35 cm @ 20 m",
    `Fish size bin *` = 1,
    `Observer emails *` = "email@mermaid.org"
  )
```

Recode visibility, check how it is formatted in template:

```{r}
fish_template_and_options[["Visibility"]][["choices"]]

fishbelt_data <- fishbelt_data %>%
  mutate(visibility = case_when(
    visibility == 1 ~ "<1m - bad",
    visibility == 5 ~ "1-5m - poor",
    visibility > 5 & visibility <= 10 ~ "5-10m",
    visibility >= 10 ~ ">10m - excellent"
  ))
```

Rename and reorder columns in one step

```{r}
names(fish_template_and_options[["Template"]])
```

```{r}
names(fishbelt_data)
```

Don't have any of `Sample time`, `Transect label`, `Relative depth`, `Tide`, `Sample unit notes`, which is fine because none of them are required

```{r}
fishbelt_data <- fishbelt_data %>%
  select(
    `Site *` = SiteID,
    `Management *` = Zone,
    `Sample date: Year *` = Year,
    `Sample date: Month *` = Month,
    `Sample date: Day *` = Day,
    `Depth *` = Depth,
    `Transect number *` = Transect_number,
    `Transect length surveyed *` = Transect_length,
    `Width *`,
    `Fish size bin *`,
    `Reef slope` = Reef_slope,
    `Visibility` = visibility,
    `Current` = current,
    `Observer emails *`,
    `Fish name *` = `Fish species`,
    `Size *` = Size_cm,
    `Count *` = Abundance
  )

fishbelt_data
```

Check columns one by one

```{r}
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Site *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Management *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Sample date: Year *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Sample date: Month *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Sample date: Day *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Depth *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Transect number *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Transect length surveyed *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Width *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Fish size bin *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Reef slope")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Visibility")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Current")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Observer emails *") # TODO
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Fish name *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Size *")
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Count *")
```

There are issues in Fish name that need to be fixed

```{r}
fishbelt_data <- fishbelt_data %>%
  mutate(`Fish name *` = case_when(
    `Fish name *` == "Parupeneus multifaskiatus" ~ "Parupeneus multifasciatus",
    `Fish name *` == "Parupeneus indikus" ~ "Parupeneus indicus",
    `Fish name *` == "Lutjanus sp." ~ "Lutjanus",
    TRUE ~ `Fish name *`
  ))
```

Check values again

```{r}
mermaid_import_check_options(fishbelt_data, fish_template_and_options, "Fish name *")
```

Save clean file

```{r save-run, echo = FALSE}
write_delim(fishbelt_data, here::here("inst", "extdata", "import-fishbelt-vignette", "fishbelt_clean.csv"), delim = ";")
```

```{r save-show, eval = FALSE}
write_csv(fishbelt_data, "fishbelt_clean.csv")
```

```{r email-edit, echo = FALSE}
# Actually use real email so import does not error
fishbelt_data <- fishbelt_data %>%
  mutate(`Observer emails *` = "sharla.gelfand@gmail.com")
```

Import data to MERMAID - note this is not R checking, but the actual MERMAID API - does lots of checks that we hope to save people from having to deal with by doing all the steps first

```{r}
mermaid_import_project_data(
  fishbelt_data,
  reef_survey,
  method = "fishbelt",
  dryrun = TRUE
)
```

Not sure if we need to include clearexisting or any explanation, it is by default set to FALSE so I think better to just not mention it?

```{r}
mermaid_import_project_data(
  fishbelt_data,
  reef_survey,
  method = "fishbelt",
  dryrun = FALSE
)
```
